// Mediasoup SFU —Å–µ—Ä–≤–µ—Ä –¥–ª—è Bunker Game
const mediasoup = require('mediasoup');

let worker = null;
let router = null;
const transports = new Map(); // playerId -> {sendTransport, recvTransport}
const producers = new Map(); // playerId -> producer
const consumers = new Map(); // playerId -> Map<producerId, consumer>

// Mediasoup configuration
const MEDIASOUP_OPTIONS = {
  worker: {
    rtcMinPort: 10000,
    rtcMaxPort: 10100,
    logLevel: 'warn',
    logTags: ['info', 'ice', 'dtls', 'rtp', 'srtp', 'rtcp'],
  },
  router: {
    mediaCodecs: [
      {
        kind: 'audio',
        mimeType: 'audio/opus',
        clockRate: 48000,
        channels: 2,
      },
      {
        kind: 'video',
        mimeType: 'video/VP8',
        clockRate: 90000,
        parameters: {
          'x-google-start-bitrate': 1000,
        },
      },
    ],
  },
};

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mediasoup worker –∏ router
 */
async function initMediasoup() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å mediasoup worker
    const mediasoupPath = require.resolve('mediasoup');
    console.log('üì¶ Mediasoup –ø—É—Ç—å:', mediasoupPath);
    
    // –°–æ–∑–¥–∞–µ–º worker —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    try {
      worker = await mediasoup.createWorker({
        ...MEDIASOUP_OPTIONS.worker,
        logLevel: 'warn',
        logTags: ['info', 'ice', 'dtls', 'rtp', 'srtp', 'rtcp'],
      });
      console.log('‚úÖ Mediasoup worker —Å–æ–∑–¥–∞–Ω:', worker.pid);
    } catch (workerError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è worker:', workerError);
      
      // –ï—Å–ª–∏ worker –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ Render.com), –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
      if (process.env.RENDER || process.env.NODE_ENV === 'production') {
        console.warn('‚ö†Ô∏è Mediasoup worker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback —Ä–µ–∂–∏–º.');
        // –í fallback —Ä–µ–∂–∏–º–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mesh —Ç–æ–ø–æ–ª–æ–≥–∏—é –∏–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥
        return null;
      }
      throw workerError;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ worker
    worker.on('died', () => {
      console.error('‚ùå Mediasoup worker —É–º–µ—Ä, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º...');
      setTimeout(() => {
        initMediasoup().catch(err => {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å worker:', err);
        });
      }, 1000);
    });

    // –°–æ–∑–¥–∞–µ–º router
    router = await worker.createRouter(MEDIASOUP_OPTIONS.router);
    console.log('‚úÖ Mediasoup router —Å–æ–∑–¥–∞–Ω:', router.id);

    return { worker, router };
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Mediasoup:', error);
    console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message, error.stack);
    
    // –ù–∞ Render.com Mediasoup –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ –Ω–∞—Ç–∏–≤–Ω–æ–π —Å–±–æ—Ä–∫–∏
    if (process.env.RENDER) {
      console.warn('‚ö†Ô∏è Mediasoup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ Render.com. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π VPS –¥–ª—è –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä–∞.');
    }
    
    throw error;
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç WebRTC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –∏–≥—Ä–æ–∫–∞
 */
async function createTransport(playerId, direction = 'send') {
  // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ Mediasoup –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
  await ensureMediasoupInitialized();
  
  if (!router || !mediasoupAvailable) {
    throw new Error('Router –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. Mediasoup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.');
  }

  const transport = await router.createWebRtcTransport({
    listenIps: [
      {
        ip: process.env.MEDIASOUP_LISTEN_IP || '0.0.0.0',
        announcedIp: process.env.MEDIASOUP_ANNOUNCED_IP || undefined,
      },
    ],
    enableUdp: true,
    enableTcp: true,
    preferUdp: true,
    initialAvailableOutgoingBitrate: 1000000,
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è DTLS
  transport.on('dtlsstatechange', (dtlsState) => {
    if (dtlsState === 'closed') {
      console.log(`üîå DTLS –∑–∞–∫—Ä—ã—Ç –¥–ª—è ${playerId} (${direction})`);
      transport.close();
    }
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
  if (!transports.has(playerId)) {
    transports.set(playerId, {});
  }
  const playerTransports = transports.get(playerId);
  
  if (direction === 'send') {
    playerTransports.sendTransport = transport;
  } else {
    playerTransports.recvTransport = transport;
  }

  return {
    id: transport.id,
    iceParameters: transport.iceParameters,
    iceCandidates: transport.iceCandidates,
    dtlsParameters: transport.dtlsParameters,
  };
}

/**
 * –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –∫ –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä—É
 */
async function connectPlayer(playerId) {
  // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ Mediasoup –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
  const initResult = await ensureMediasoupInitialized();
  
  if (!initResult || !mediasoupAvailable) {
    throw new Error('Mediasoup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ');
  }
  
  try {
    // –°–æ–∑–¥–∞–µ–º send transport –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ
    const sendTransportInfo = await createTransport(playerId, 'send');
    
    // –°–æ–∑–¥–∞–µ–º recv transport –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ –æ—Ç –¥—Ä—É–≥–∏—Ö
    const recvTransportInfo = await createTransport(playerId, 'recv');

    console.log(`‚úÖ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId}`);

    return {
      sendTransport: sendTransportInfo,
      recvTransport: recvTransportInfo,
    };
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ ${playerId}:`, error);
    throw error;
  }
}

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ WebRTC connect (–∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç)
 */
async function connectTransport(playerId, transportId, dtlsParameters, direction) {
  const playerTransports = transports.get(playerId);
  if (!playerTransports) {
    throw new Error(`–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
  }

  const transport = direction === 'send' 
    ? playerTransports.sendTransport 
    : playerTransports.recvTransport;

  if (!transport) {
    throw new Error(`–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${direction} –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }

  await transport.connect({ dtlsParameters });
  console.log(`‚úÖ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${direction} –ø–æ–¥–∫–ª—é—á–µ–Ω –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId}`);
}

/**
 * –°–æ–∑–¥–∞–µ—Ç producer (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ –æ—Ç –∏–≥—Ä–æ–∫–∞)
 */
async function createProducer(playerId, transportId, rtpParameters) {
  const playerTransports = transports.get(playerId);
  if (!playerTransports || !playerTransports.sendTransport) {
    throw new Error(`Send transport –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }

  const producer = await playerTransports.sendTransport.produce({ rtpParameters });
  producers.set(playerId, producer);

  console.log(`‚úÖ Producer —Å–æ–∑–¥–∞–Ω –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId}:`, producer.id);

  return {
    id: producer.id,
    kind: producer.kind,
    rtpParameters: producer.rtpParameters,
  };
}

/**
 * –°–æ–∑–¥–∞–µ—Ç consumer (–ø–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞)
 */
async function createConsumer(playerId, producerId, rtpCapabilities) {
  const playerTransports = transports.get(playerId);
  if (!playerTransports || !playerTransports.recvTransport) {
    throw new Error(`Recv transport –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }

  // –ù–∞—Ö–æ–¥–∏–º producer
  let producer = null;
  for (const [pid, p] of producers.entries()) {
    if (p.id === producerId) {
      producer = p;
      break;
    }
  }

  if (!producer) {
    throw new Error(`Producer ${producerId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–µ—Ç –ª–∏ router –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —ç—Ç–æ—Ç –∫–æ–¥–µ–∫
  if (!router.canConsume({ producerId: producer.id, rtpCapabilities })) {
    throw new Error('Router –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å consumer –¥–ª—è —ç—Ç–æ–≥–æ producer');
  }

  const consumer = await playerTransports.recvTransport.consume({
    producerId: producer.id,
    rtpCapabilities,
    paused: false,
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º consumer
  if (!consumers.has(playerId)) {
    consumers.set(playerId, new Map());
  }
  consumers.get(playerId).set(producerId, consumer);

  console.log(`‚úÖ Consumer —Å–æ–∑–¥–∞–Ω –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${playerId} –æ—Ç producer ${producerId}`);

  return {
    id: consumer.id,
    producerId: consumer.producerId,
    kind: consumer.kind,
    rtpParameters: consumer.rtpParameters,
  };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö producers (–¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤)
 */
function getProducers(playerId) {
  const producerList = [];
  
  for (const [pid, producer] of producers.entries()) {
    if (pid !== playerId && producer && !producer.closed) {
      producerList.push({
        id: producer.id,
        playerId: pid,
        kind: producer.kind,
      });
    }
  }

  return producerList;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç RTP capabilities router
 */
async function getRouterRtpCapabilities() {
  const initResult = await ensureMediasoupInitialized();
  
  if (!initResult || !router || !mediasoupAvailable) {
    throw new Error('Router –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. Mediasoup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.');
  }
  return router.rtpCapabilities;
}

/**
 * –û—Ç–∫–ª—é—á–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –æ—Ç –º–µ–¥–∏–∞-—Å–µ—Ä–≤–µ—Ä–∞
 */
async function disconnectPlayer(playerId) {
  try {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º transports
    const playerTransports = transports.get(playerId);
    if (playerTransports) {
      if (playerTransports.sendTransport) {
        playerTransports.sendTransport.close();
      }
      if (playerTransports.recvTransport) {
        playerTransports.recvTransport.close();
      }
      transports.delete(playerId);
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º producer
    const producer = producers.get(playerId);
    if (producer) {
      producer.close();
      producers.delete(playerId);
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º consumers
    const playerConsumers = consumers.get(playerId);
    if (playerConsumers) {
      playerConsumers.forEach(consumer => consumer.close());
      consumers.delete(playerId);
    }

    console.log(`‚úÖ –ò–≥—Ä–æ–∫ ${playerId} –æ—Ç–∫–ª—é—á–µ–Ω –æ—Ç Mediasoup`);
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ ${playerId}:`, error);
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞)
let initPromise = null;
let mediasoupAvailable = false;

async function ensureMediasoupInitialized() {
  if (initPromise === null) {
    initPromise = (async () => {
      try {
        const result = await initMediasoup();
        if (result) {
          mediasoupAvailable = true;
          console.log('‚úÖ Mediasoup —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
          return result;
        } else {
          mediasoupAvailable = false;
          console.warn('‚ö†Ô∏è Mediasoup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback');
          return null;
        }
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Mediasoup:', err.message);
        mediasoupAvailable = false;
        console.warn('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ Mediasoup SFU. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ mesh —Ç–æ–ø–æ–ª–æ–≥–∏—è.');
        return null;
      }
    })();
  }
  return initPromise;
}

// –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
setTimeout(() => {
  ensureMediasoupInitialized().catch(() => {
    // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ ensureMediasoupInitialized
  });
}, 100);

module.exports = {
  connectPlayer,
  connectTransport,
  createProducer,
  createConsumer,
  getProducers,
  getRouterRtpCapabilities,
  disconnectPlayer,
  router,
  isAvailable: () => mediasoupAvailable,
};

